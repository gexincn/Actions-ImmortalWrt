name: Build ImmortalWrt

on:
  workflow_dispatch:
  push:

env:
  TZ: Asia/Shanghai
  DEBIAN_FRONTEND: noninteractive

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Maximize Build Disk Space (clean Ubuntu & mount /mnt SSD)
      run: |
        echo "==== 清理系统预装软件，释放空间 ===="
        sudo systemctl stop docker || true
        sudo systemctl disable docker || true

        sudo swapoff -a || true
        sudo rm -f /swapfile || true

        sudo apt-get remove -y \
          azure-cli google-chrome-stable firefox \
          docker.io docker-compose moby-engine moby-cli || true

        sudo apt-get autoremove -y
        sudo apt-get autoremove --purge -y
        sudo apt-get clean
        sudo apt-get autoclean

        echo "==== 删除大文件目录 ===="
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /usr/local/share/boost

        echo "==== /mnt SSD 提速 ===="
        df -h
        echo "系统磁盘空间清理完成！"

    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup build env
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib \
        gettext git libncurses5-dev libssl-dev python3 python3-pip python3-distutils \
        rsync unzip zlib1g-dev file wget curl

    - name: Download OpenWrt Source
      run: |
        git clone https://github.com/immortalwrt/immortalwrt openwrt
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Run DIY Part 1
      run: |
        cd openwrt
        chmod +x ../diy-part1.sh
        ../diy-part1.sh

    - name: Load Custom Config
      run: |
        cd openwrt
        cp -f ../.config ./

    - name: Run DIY Part 2
      run: |
        cd openwrt
        chmod +x ../diy-part2.sh
        ../diy-part2.sh

    - name: Prepare /mnt build directory (SSD 提速)
      run: |
        echo "==== 将 OpenWrt 复制到 /mnt/owrt ===="
        sudo mkdir -p /mnt/owrt
        sudo rsync -aHAXS --delete openwrt/ /mnt/owrt/
        echo "==== 切换工作目录到 /mnt/owrt ===="

    - name: Compile firmware (超高速)
      run: |
        cd /mnt/owrt
        echo "使用 SSD /mnt 编译"
        make -j$(nproc) || make -j1 V=s

    - name: Package Firmware
      run: |
        mkdir -p artifacts
        cp -rf /mnt/owrt/bin/targets/*/*/* artifacts/

    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: ImmortalWrt_Firmware
        path: artifacts
