name: Update Checker ImmortalWrt TR3000

on:
  workflow_dispatch:
  schedule:
    - cron: '0 19 * * *'  # 北京时间凌晨3点

jobs:
  check-updates:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get ImmortalWrt commit hash
        id: get-immortalwrt
        run: |
          git clone --depth=1 https://github.com/immortalwrt/immortalwrt -b openwrt-24.10 immortalwrt
          cd immortalwrt
          echo "commit_hash=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Cache ImmortalWrt hash
        id: cache-immortalwrt
        uses: actions/cache@v3
        with:
          path: .cache-immortalwrt
          # 在 key 后加上 tr3000 标记，避免与 X86 workflow 冲突
          key: immortalwrt-tr3000-${{ steps.get-immortalwrt.outputs.commit_hash }}

      - name: Save ImmortalWrt commit
        if: steps.cache-immortalwrt.outputs.cache-hit != 'true'
        run: |
          mkdir -p .cache-immortalwrt
          echo "${{ steps.get-immortalwrt.outputs.commit_hash }}" > .cache-immortalwrt/hash.txt

      - name: Trigger build workflow
        if: steps.cache-immortalwrt.outputs.cache-hit != 'true'
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: Source Code Update - ImmortalWrt TR3000
          client-payload: |
            {
              "immortalwrt_updated": ${{ steps.cache-immortalwrt.outputs.cache-hit != 'true' }}
            }

      - name: Clean old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          retain_days: 0
          keep_minimum_runs: 2
