name: ImmortalWrt-Filogic-Cudy-TR3000

permissions: write-all

on:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: master
  TAG: v24.10.4

  CONFIG_FILE: tr3000/tr3000.config
  DIY_P1_SH: tr3000/diy-part1.sh
  DIY_P2_SH: tr3000/diy-part2.sh

  TZ: Asia/Shanghai
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set timezone
      run: sudo timedatectl set-timezone "$TZ"

    - name: Clone ImmortalWrt
      run: |
        git clone --depth=1 -b $REPO_BRANCH $REPO_URL openwrt

    - name: Load custom feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Apply TR3000 .config
      run: |
        cd openwrt
        cp ../$CONFIG_FILE .config
        make defconfig

    - name: Run DIY Part 1
      run: |
        cd openwrt
        chmod +x ../$DIY_P1_SH
        ../$DIY_P1_SH

    - name: Run DIY Part 2
      run: |
        cd openwrt
        chmod +x ../$DIY_P2_SH
        ../$DIY_P2_SH

    - name: Get version info
      run: |
        cd openwrt

        IMMORTALWRT_VERSION=$(grep PRETTY_NAME package/base-files/files/usr/lib/os-release | cut -d= -f2 | tr -d '"')

        OPENCLASH_VERSION=$(grep PKG_VERSION luci/applications/luci-app-openclash/Makefile | cut -d= -f2)

        PASSWALL_VERSION=$(grep PKG_VERSION feeds/passwall/luci-app-passwall/Makefile | cut -d= -f2)

        MOSDNS_VERSION=$(grep PKG_VERSION feeds/packages/net/mosdns/Makefile | cut -d= -f2)

        echo "IMMORTALWRT_VERSION=$IMMORTALWRT_VERSION" >> $GITHUB_ENV
        echo "OPENCLASH_VERSION=$OPENCLASH_VERSION" >> $GITHUB_ENV
        echo "PASSWALL_VERSION=$PASSWALL_VERSION" >> $GITHUB_ENV
        echo "MOSDNS_VERSION=$MOSDNS_VERSION" >> $GITHUB_ENV

    - name: Build firmware
      run: |
        cd openwrt
        make -j$(nproc) || make -j1 V=s

    - name: Prepare firmware
      id: organize
      if: success()
      run: |
        cd openwrt/bin/targets/*/*
        rm -rf packages
        find . -type f -size 0 -delete
        find . -type f ! -name "*squashfs-sysupgrade.bin" -delete

        BUILD_DATE_FULL=$(date +'%Y.%m.%d.%H.%M')
        echo "BUILD_DATE_FULL=$BUILD_DATE_FULL" >> $GITHUB_ENV

        for f in *squashfs-sysupgrade.bin; do
          mv -- "$f" "${BUILD_DATE_FULL}-$f"
        done

        # 只保留最近 6 个固件
        ls -1t *.bin | tail -n +7 | xargs -r rm -f

        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Upload firmware
      if: steps.organize.outputs.status == 'success'
      uses: actions/upload-artifact@v4
      with:
        name: TR3000-Firmware
        path: ${{ env.FIRMWARE }}

    - name: Generate Release
      if: steps.organize.outputs.status == 'success'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ env.TAG }}
        files: ${{ env.FIRMWARE }}/*
        body: |
          **Device:** Cudy TR3000 (Filogic)
          **ImmortalWrt:** ${{ env.IMMORTALWRT_VERSION }}
          **OpenClash:** ${{ env.OPENCLASH_VERSION }}
          **PassWall:** ${{ env.PASSWALL_VERSION }}
          **MosDNS:** ${{ env.MOSDNS_VERSION }}
          **Build Time:** ${{ env.BUILD_DATE_FULL }}
